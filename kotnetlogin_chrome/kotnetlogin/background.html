<script>
// Keep this counter to avoid failing submit loops when the credentials are invalid
var counter = 0;

var MAX_COUNTER = 5;

// Reset the counter
function resetCounter(){
	counter = 0;
}
// Reset the counter every minute
setInterval('resetCounter()',10000);

// Start listening for requests for information
chrome.extension.onRequest.addListener(
  function(request, sender, sendResponse) {
	// If we aren't active, we do nothing
	if(localStorage.active == 0){
		return;
	}
	// Check if we didn't request too much information in a short interval. That would be a sign of wrong credentials
	if(counter >= MAX_COUNTER){
		// Send back null to indicate a failure.
		sendResponse(null);
		return;
	}
	counter++;
	// If the request is for information send back the username, password, institute and status
    if (request.name == 'info') 
      sendResponse({user : localStorage.user, pass : localStorage.pass, inst : localStorage.inst});
  });

// Listen for click events on the extension icon	  
chrome.browserAction.onClicked.addListener(function(tab) {
	// switch the status of extension between active and inactive
  if (localStorage.active == 1) localStorage.active = 0;
  else if (localStorage.active == 0) localStorage.active = 1;
	
  init();
});

// Initialize the extension
function init() {
	// If no institute was chosen, select kuleuven as default
  if (localStorage.inst == null)
    localStorage.inst = "kuleuven"

	// If the extension is not active, set the appropriate icon and label
  if (localStorage.active == 0) {
    chrome.browserAction.setIcon({path: "icon.png"});
    chrome.browserAction.setBadgeText({text: 'uit'});
  }
	// If the extension is active, set the appropriate icon and label
  else if (localStorage.active == 1) {
    chrome.browserAction.setIcon({path: "icon.png"});
    chrome.browserAction.setBadgeText({text: ''});
  }
  else {
	// If the local storage doesn't contain the status of the extension, it was just installed
	// Open the options page
    chrome.browserAction.setIcon({path: "icon.png"});
    chrome.browserAction.setBadgeText({text: 'uit'});
    chrome.tabs.create({url : chrome.extension.getURL("options.html")});
  }
}

init();
</script>