<!DOCTYPE HTML>
<html>
<head>
<title>global HTML page</title>
<script type="text/javascript">

// Counter to prevent loops of failing logins
var counter = 0;
var MAX_COUNTER = 10;
// Reset the counter
function resetCounter(){
	counter = 0;
}
// Reset the counter every minute
setInterval('resetCounter()',60000);
// Reset the counter when settings are changed
safari.extension.settings.addEventListener("change", resetCounter, false);

/*
// This code listens for presses on the toggle button,
// but because it's impossible to visualize the state of the extension in a user-friendly way (e.g. a label on the button)
// We don't use it

// Listen for button presses
safari.application.addEventListener("command", trigger, false);

function toggle(event){
	if(event.command == 'toggle'){
		safari.extension.settings.active = !safari.extension.settings.active;
	}
}
*/
// Send the requested info back to the requester
function sendSettings(event) {
	
	// If we aren't active, we do nothing
	if(!safari.extension.settings.active){
		return;
	}
	
	// We are only interested in events requesting information from settings
	if(event.name != 'getInfo'){
		return;
	}
	
	// Check if we requested the credentials/institute too many times (indication of invalid credentials)
	if(counter >= MAX_COUNTER){
		// We did, send an error instead of the requested info.
		event.target.page.dispatchMessage('error','toomany');
		return;
	}
	// Increase the counter
	counter++;
	
	// create response	
	var response = new Object();
	// Read the institute, username and password from the settings
	response.institute = safari.extension.settings.institute;
	response.username = safari.extension.secureSettings.username;
	response.password = safari.extension.secureSettings.password;
	// Send the requested data back, using the name of the requested data as name for the response
	if(response.username == undefined || response.password == undefined){
		event.target.page.dispatchMessage('error','nocredentials');
	} else {
		event.target.page.dispatchMessage(event.message, response);
	}
}

// Listen for messages and pass them to the sendSettings function
safari.application.addEventListener("message",sendSettings,false);

</script>
</head>
<body>
</body>
</html>